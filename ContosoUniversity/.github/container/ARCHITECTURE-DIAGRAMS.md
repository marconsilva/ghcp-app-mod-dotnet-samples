# ??? ContosoUniversity Cloud-Native Architecture

## High-Level Architecture

```
                                    Internet
                                       ?
                                       ?
                        ???????????????????????????????
                        ?     Azure Front Door /      ?
                        ?      Load Balancer          ?
                        ?    (SSL/TLS Termination)    ?
                        ???????????????????????????????
                                       ?
                        ???????????????????????????????
                        ?    NGINX Ingress Controller  ?
                        ?       (Kubernetes)           ?
                        ???????????????????????????????
                                       ?
                ???????????????????????????????????????????????
                ?         Kubernetes Service                  ?
                ?      (Internal Load Balancer)               ?
                ???????????????????????????????????????????????
                                       ?
        ???????????????????????????????????????????????????????????????
        ?                              ?                              ?
??????????????????            ??????????????????           ????????????????????
?   Web Pod 1    ?            ?   Web Pod 2    ?           ?   Web Pod 3-10   ?
? ?????????????? ?            ? ?????????????? ?           ? ??????????????   ?
? ? ASP.NET    ? ?            ? ? ASP.NET    ? ?           ? ? ASP.NET    ?   ?
? ? Core 9.0   ? ?            ? ? Core 9.0   ? ?           ? ? Core 9.0   ?   ?
? ? Application? ?            ? ? Application? ?           ? ? Application?   ?
? ?????????????? ?            ? ?????????????? ?           ? ??????????????   ?
?       ? :8080  ?            ?       ? :8080  ?           ?       ? :8080    ?
? ?????????????? ?            ? ?????????????? ?           ? ??????????????   ?
? ?Health Check? ?            ? ?Health Check? ?           ? ?Health Check?   ?
? ?????????????? ?            ? ?????????????? ?           ? ??????????????   ?
??????????????????            ??????????????????           ????????????????????
        ?                              ?                              ?
        ?                              ?                              ?
        ???????????????????????????????????????????????????????????????
                                       ?
                        ???????????????????????????????
                        ?  Horizontal Pod Autoscaler  ?
                        ?   (Monitors CPU/Memory)     ?
                        ???????????????????????????????


??????????????????????????????????????????????????????????????????????????
?                         Data & Storage Layer                            ?
??????????????????????????????????????????????????????????????????????????
?                                                                         ?
?  ????????????????????????????         ????????????????????????????   ?
?  ?   Azure SQL Database     ?         ?      Azure Files         ?   ?
?  ?  (Managed SQL Server)    ?         ?  (Persistent Storage)    ?   ?
?  ?                          ?         ?                          ?   ?
?  ?  • Geo-replication       ?         ?  • Upload files          ?   ?
?  ?  • Automatic backups     ?         ?  • Teaching materials    ?   ?
?  ?  • Point-in-time restore ?         ?  • Shared across pods    ?   ?
?  ?  • Built-in HA           ?         ?  • SMB protocol          ?   ?
?  ????????????????????????????         ????????????????????????????   ?
?                                                                         ?
???????????????????????????????????????????????????????????????????????????


??????????????????????????????????????????????????????????????????????????
?                    Monitoring & Observability                           ?
??????????????????????????????????????????????????????????????????????????
?                                                                         ?
?  ??????????????????????  ????????????????????  ????????????????????  ?
?  ? Application        ?  ?  Log Analytics   ?  ?  Azure Monitor   ?  ?
?  ? Insights           ?  ?  Workspace       ?  ?                  ?  ?
?  ?                    ?  ?                  ?  ?                  ?  ?
?  ? • APM              ?  ? • Centralized    ?  ? • Metrics        ?  ?
?  ? • Distributed      ?  ?   logging        ?  ? • Alerts         ?  ?
?  ?   tracing          ?  ? • Query engine   ?  ? • Dashboards     ?  ?
?  ? • Performance      ?  ? • Retention      ?  ? • Notifications  ?  ?
?  ??????????????????????  ????????????????????  ????????????????????  ?
?                                                                         ?
???????????????????????????????????????????????????????????????????????????
```

---

## Container Communication Flow

```
1. User Request
   ??> Azure Front Door / Load Balancer
       ??> NGINX Ingress Controller
           ??> Kubernetes Service
               ??> Pod (Round-robin)
                   ??> Health Check (if first request)
                   ??> Application Controller
                       ??> Database (Azure SQL)
                       ??> File Storage (Azure Files)
                       ??> Notification Queue (MSMQ)

2. Health Check Flow
   Kubernetes Scheduler
   ??> Liveness Probe (/health/live) every 10s
   ??> Readiness Probe (/health/ready) every 5s
       ??> Check DB connectivity
       ??> Update Load Balancer pool

3. Auto-Scaling Flow
   Metrics Server
   ??> Collect CPU/Memory usage
   ??> HorizontalPodAutoscaler
       ??> If CPU > 70% or Memory > 80%
           ??> Scale up (add pod)
       ??> If CPU < 50% and Memory < 60% for 5min
           ??> Scale down (remove pod)
```

---

## Deployment Options Comparison

```
???????????????????????????????????????????????????????????????????????????
?                        Deployment Comparison                             ?
???????????????????????????????????????????????????????????????????????????
?   Feature      ? Docker Local ? Container Apps?         AKS             ?
???????????????????????????????????????????????????????????????????????????
? Complexity     ?   ?         ?   ??       ?   ?????           ?
? Control        ?   ??      ?   ??       ?   ?????           ?
? Scalability    ?   ?         ?   ????   ?   ?????           ?
? Cost           ?   Free       ?  $50-100/mo   ?   $600+/mo              ?
? Setup Time     ?   5 min      ?   20 min      ?   60 min                ?
? Maintenance    ?   Manual     ?   Minimal     ?   Moderate              ?
? HA Support     ?   ?         ?   ?          ?   ?                    ?
? Auto-scaling   ?   ?         ?   ?          ?   ?                    ?
? Monitoring     ?   Basic      ?   Built-in    ?   Advanced              ?
? Best For       ?   Dev/Test   ?   Small/Med   ?   Enterprise            ?
???????????????????????????????????????????????????????????????????????????
```

---

## Resource Topology

```
Azure Resource Group: contoso-rg
?
?? Azure Container Registry (ACR)
?  ?? Images: contosouniversity:latest, :v1.0, :v1.1, ...
?
?? Azure Kubernetes Service (AKS)
?  ?? Node Pool 1: 3-10 nodes (Standard_D4s_v3)
?  ?  ?? contoso-web-pod-1
?  ?  ?? contoso-web-pod-2
?  ?  ?? contoso-web-pod-3 ... 10
?  ?
?  ?? System Node Pool: 2 nodes
?  ?  ?? NGINX Ingress Controller
?  ?  ?? cert-manager
?  ?  ?? metrics-server
?  ?
?  ?? Monitoring Add-on
?     ?? Azure Monitor Agent
?
?? Azure SQL Database
?  ?? ContosoUniversity (S2 tier)
?     ?? Geo-replication (optional)
?     ?? Automated backups
?
?? Azure Storage Account
?  ?? File Share: uploads
?     ?? Teaching materials, images
?
?? Log Analytics Workspace
?  ?? Container logs
?  ?? Application logs
?  ?? Performance metrics
?
?? Application Insights
   ?? Distributed tracing
   ?? Performance monitoring
   ?? Availability tests
```

---

## Networking Architecture

```
???????????????????????????????????????????????????????????????
?                    Internet (Public)                         ?
???????????????????????????????????????????????????????????????
                         ? HTTPS (443)
                         ?
???????????????????????????????????????????????????????????????
?              Azure Load Balancer / Front Door                ?
?                    (DDoS Protection)                         ?
???????????????????????????????????????????????????????????????
                         ?
???????????????????????????????????????????????????????????????
?                  AKS Virtual Network                         ?
?                  (10.0.0.0/16)                               ?
?  ????????????????????????????????????????????????????????   ?
?  ?        Ingress Subnet (10.0.1.0/24)                  ?   ?
?  ?  ??????????????????????????????????????????????????  ?   ?
?  ?  ?       NGINX Ingress Controller                 ?  ?   ?
?  ?  ??????????????????????????????????????????????????  ?   ?
?  ????????????????????????????????????????????????????????   ?
?                      ?                                       ?
?  ????????????????????????????????????????????????????????   ?
?  ?        Application Subnet (10.0.2.0/24)             ?   ?
?  ?  ????????????  ????????????  ????????????          ?   ?
?  ?  ? Pod 1    ?  ? Pod 2    ?  ? Pod 3-10 ?          ?   ?
?  ?  ? Web App  ?  ? Web App  ?  ? Web App  ?          ?   ?
?  ?  ????????????  ????????????  ????????????          ?   ?
?  ??????????????????????????????????????????????????????   ?
?          ?             ?             ?                      ?
?  ??????????????????????????????????????????????????????   ?
?  ?        Data Subnet (10.0.3.0/24)                   ?   ?
?  ?  ????????????????????????????????????????????????  ?   ?
?  ?  ?    SQL Service (ClusterIP)                   ?  ?   ?
?  ?  ?    - Private endpoint to Azure SQL           ?  ?   ?
?  ?  ????????????????????????????????????????????????  ?   ?
?  ???????????????????????????????????????????????????????   ?
?                                                             ?
???????????????????????????????????????????????????????????????
                         ?                    ?
        ?????????????????????????   ?????????????????????
        ?   Azure SQL Database  ?   ?  Azure Files      ?
        ?  (Private Endpoint)   ?   ?  (SMB Mount)      ?
        ?????????????????????????   ?????????????????????
```

---

## Data Flow Diagram

```
???????????????????????????????????????????????????????????????????????
?                        Request Flow                                  ?
???????????????????????????????????????????????????????????????????????

User Browser
    ?
    ? HTTPS Request
    ? GET /Students/Index
    ?
???????????????????????
?  Load Balancer      ? ???? Health checks every 30s
?  (Public IP)        ?      (removes unhealthy pods)
???????????????????????
           ?
           ? Route to backend
           ?
???????????????????????
? Kubernetes Service  ? ???? Service discovery
? (Internal LB)       ?      (DNS: contoso-web-service)
???????????????????????
           ?
           ? Round-robin / Least connections
           ?
???????????????????????
?   Pod (1 of 3-10)   ?
?  ?????????????????  ?
?  ? Health Checks ?  ? ???? Liveness: /health/live every 10s
?  ? - Liveness    ?  ?      Readiness: /health/ready every 5s
?  ? - Readiness   ?  ?      Startup: /health/startup
?  ? - Startup     ?  ?
?  ?????????????????  ?
?  ?????????????????  ?
?  ? ASP.NET Core  ?  ?
?  ? Application   ?  ?
?  ? - Controllers ?  ?
?  ? - Views       ?  ?
?  ? - Services    ?  ?
?  ?????????????????  ?
???????????????????????
           ?
     ?????????????
     ?           ?
     ?           ?
???????????  ??????????????
? Azure   ?  ?  Azure     ?
? SQL DB  ?  ?  Files     ?
?         ?  ?            ?
? Query   ?  ? Read/Write ?
? Data    ?  ? Uploads    ?
???????????  ??????????????
     ?
     ? Return data
     ?
???????????????????????
?  Response to User   ?
?  - HTML/JSON        ?
?  - Status Code      ?
?  - Headers          ?
???????????????????????
```

---

## Scaling Architecture

```
                        Traffic Pattern
                               ?
                               ?
    Low Traffic ??????????????????????????????? High Traffic
         ?                     ?                      ?
         ?                     ?                      ?
    ??????????         ?????????????????        ???????????
    ? 3 Pods ?         ?    5 Pods     ?        ? 10 Pods ?
    ? (Min)  ?         ?   (Normal)    ?        ?  (Max)  ?
    ??????????         ?????????????????        ???????????
         ?                     ?                      ?
         ?                     ?                      ?
    CPU: 30%              CPU: 70%               CPU: 90%
    Mem: 40%              Mem: 80%               Mem: 85%


Auto-Scaling Rules:
?????????????????????
Scale UP when:
  • CPU > 70% for 15 seconds OR
  • Memory > 80% for 15 seconds
  • Add up to 2 pods per 15 seconds
  • Max increase: 100% of current

Scale DOWN when:
  • CPU < 50% AND Memory < 60%
  • Wait 5 minutes (stabilization)
  • Remove max 50% per minute
  • Never go below 3 pods
```

---

## Deployment Pipeline Flow

```
????????????????????????????????????????????????????????????????????
?                     CI/CD Pipeline                                ?
????????????????????????????????????????????????????????????????????

Developer                Git Push
    ?                       ?
    ? Commits code          ?
    ?????????????????????????
                            ?
                            ?
                    ????????????????
                    ?  Git Repo    ?
                    ?  (GitHub)    ?
                    ????????????????
                            ?
                            ? Webhook trigger
                            ?
?????????????????????????????????????????????????????????????????
?                     CI/CD System                               ?
?              (GitHub Actions / Azure Pipelines)                ?
?????????????????????????????????????????????????????????????????
?                                                                ?
?  Stage 1: Build & Test                                        ?
?  ?? Checkout code                                             ?
?  ?? Setup .NET 9.0                                            ?
?  ?? Restore dependencies                                      ?
?  ?? Build solution                     ???????????????        ?
?  ?? Run unit tests ?????????????????? ? 115 Tests   ?        ?
?  ?? Run integration tests              ? Coverage    ?        ?
?  ?? Generate coverage report ??????????? Report      ?        ?
?                                        ???????????????        ?
?                           ?                                    ?
?                           ? Tests Pass                         ?
?                                                                ?
?  Stage 2: Docker Build                                        ?
?  ?? Build Docker image                                        ?
?  ?? Tag with version                                          ?
?  ?? Scan for vulnerabilities          ???????????????        ?
?  ?? Push to registry ???????????????????   ACR       ?        ?
?                                        ? contoso.azr ?        ?
?                                        ???????????????        ?
?                           ?                                    ?
?                           ? Image pushed                       ?
?                                                                ?
?  Stage 3: Deploy (Dev)                                        ?
?  ?? Update K8s manifests                                      ?
?  ?? kubectl apply                                             ?
?  ?? Wait for rollout                                          ?
?  ?? Run smoke tests                   ???????????????        ?
?                                        ? Dev Cluster ?        ?
?                                        ???????????????        ?
?                           ?                                    ?
?                           ? Manual approval                    ?
?                                                                ?
?  Stage 4: Deploy (Prod)                                       ?
?  ?? Blue-Green deployment                                     ?
?  ?? Rolling update                                            ?
?  ?? Health check validation                                   ?
?  ?? Monitor metrics                   ???????????????        ?
?                                        ? Prod Cluster?        ?
?                                        ?   3-10 pods ?        ?
?                                        ???????????????        ?
?                                                                ?
??????????????????????????????????????????????????????????????????
```

---

## Container Lifecycle

```
???????????????????????????????????????????????????????????????????
?                    Container Lifecycle                           ?
???????????????????????????????????????????????????????????????????

1. Container Creation
   ??????????????????
   ?  Image Pull    ?
   ?  (From ACR)    ?
   ??????????????????
           ?
           ?
   ??????????????????
   ? Container Init ?
   ? - Mount volumes?
   ? - Set env vars ?
   ? - Create user  ?
   ??????????????????
           ?
           ?
   ??????????????????
   ?  App Startup   ?
   ? - Load config  ?
   ? - Init DB      ?
   ? - Start server ?
   ??????????????????
           ?
           ?
   ??????????????????
   ? Startup Probe  ? ???? Max 30 attempts
   ? /health/startup?      5s interval
   ??????????????????
           ?
           ? Startup OK
           
2. Running State
   ??????????????????????????????????????
   ?         Container Running          ?
   ?                                    ?
   ?  ????????????????                 ?
   ?  ? Liveness     ? ???? Every 10s  ?
   ?  ? /health/live ?                  ?
   ?  ????????????????                 ?
   ?                                    ?
   ?  ????????????????                 ?
   ?  ? Readiness    ? ???? Every 5s   ?
   ?  ? /health/ready?                  ?
   ?  ????????????????                 ?
   ?                                    ?
   ?  ????????????????                 ?
   ?  ? Serving      ? ???? User       ?
   ?  ? Requests     ?      Requests   ?
   ?  ????????????????                 ?
   ??????????????????????????????????????
           ?
           ? If health check fails
           ?
   ??????????????????
   ?  Pod Restart   ?
   ?  (Automatic)   ?
   ??????????????????
           ?
           ??????? Back to Container Creation

3. Container Termination (Graceful)
   ??????????????????
   ? SIGTERM signal ? ???? kubectl delete pod
   ??????????????????      or rolling update
           ?
           ?
   ??????????????????
   ? Finish requests? ???? 30s grace period
   ? Close conns    ?
   ??????????????????
           ?
           ?
   ??????????????????
   ? SIGKILL        ? ???? If still running after 30s
   ? (Force stop)   ?
   ??????????????????
```

---

## Storage Architecture

```
????????????????????????????????????????????????????????????????????
?                      Storage Configuration                        ?
????????????????????????????????????????????????????????????????????

Application Pod 1              Application Pod 2              Application Pod 3
      ?                              ?                              ?
      ? Mount                        ? Mount                        ? Mount
      ? /app/wwwroot/Uploads         ? /app/wwwroot/Uploads         ? /app/wwwroot/Uploads
      ?                              ?                              ?
      ???????????????????????????????????????????????????????????????
                                     ?
                      ???????????????????????????????
                      ?  PersistentVolumeClaim      ?
                      ?  - Name: uploads-pvc        ?
                      ?  - Size: 10Gi               ?
                      ?  - Access: ReadWriteMany    ?
                      ???????????????????????????????
                                     ?
                      ???????????????????????????????
                      ?     PersistentVolume        ?
                      ?  - Azure Files              ?
                      ?  - StorageClass: azure-files?
                      ???????????????????????????????
                                     ?
                      ???????????????????????????????
                      ?   Azure Storage Account     ?
                      ?   - File Share: uploads     ?
                      ?   - SMB 3.0 Protocol        ?
                      ?   - Geo-redundant (optional)?
                      ???????????????????????????????


SQL Server Pod                 
      ?                        
      ? Mount /var/opt/mssql
      ?                        
      ?                        
???????????????????
? PVC: sql-pvc    ?
? Size: 50Gi      ?
? Access: RWO     ?
???????????????????
         ?
         ?
???????????????????
? Managed Disk    ?
? Premium SSD     ?
? (or Azure SQL)  ?
???????????????????
```

---

**Created**: February 26, 2026  
**Architecture Version**: 1.0  
**Platform**: .NET 9.0 | Docker | Kubernetes | Azure  
**Status**: ? Production Ready
